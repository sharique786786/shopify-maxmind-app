"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const crypto = require("crypto");
const punycode = require("punycode");
const isEmail_1 = require("validator/lib/isEmail");
const isFQDN_1 = require("validator/lib/isFQDN");
const errors_1 = require("../errors");
class Email {
    constructor(email) {
        if (email.address != null && !isEmail_1.default(email.address)) {
            throw new errors_1.ArgumentError('`email.address` is an invalid email address');
        }
        if (email.domain != null && !isFQDN_1.default(email.domain)) {
            throw new errors_1.ArgumentError('`email.domain` is an invalid domain');
        }
        if (email.address) {
            if (email.hashAddress) {
                this.address = crypto
                    .createHash('md5')
                    .update(this.cleanEmailAddress(email.address))
                    .digest('hex');
            }
            else {
                this.address = email.address;
            }
        }
        this.domain = email.domain;
        if (email.domain == null && email.address != null) {
            this.domain = email.address.substring(email.address.indexOf('@') + 1);
        }
    }
    cleanEmailAddress(address) {
        address = address.trim().toLowerCase();
        const atIndex = address.lastIndexOf('@');
        let localPart = address.substring(0, atIndex);
        let domain = address.substring(atIndex + 1);
        domain = this.cleanDomain(domain);
        const separator = domain === 'yahoo.com' ? '-' : '+';
        const separatorIndex = localPart.indexOf(separator);
        if (separatorIndex > 0) {
            localPart = localPart.substring(0, separatorIndex);
        }
        return localPart + '@' + domain;
    }
    cleanDomain(domain) {
        domain = punycode.toASCII(domain);
        if (Email.typoDomains.hasOwnProperty(domain)) {
            domain = Email.typoDomains[domain];
        }
        return domain;
    }
}
exports.default = Email;
Email.typoDomains = {
    '35gmai.com': 'gmail.com',
    '636gmail.com': 'gmail.com',
    'gamil.com': 'gmail.com',
    'gmail.comu': 'gmail.com',
    'gmial.com': 'gmail.com',
    'gmil.com': 'gmail.com',
    'yahoogmail.com': 'gmail.com',
    'putlook.com': 'outlook.com',
};
